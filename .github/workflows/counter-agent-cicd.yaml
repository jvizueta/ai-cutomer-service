name: Counter Agent CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/counter-agent/**'
      - '.github/workflows/counter-agent-cicd.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/counter-agent/**'
      - '.github/workflows/counter-agent-cicd.yaml'

env:
  registry: ghcr.io
  username: ${{ github.repository_owner }}
  password: ${{ secrets.GITHUB_TOKEN }}
  IMAGE_NAME: ghcr.io/${{ github.repository }}/counter-agent

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to registry
        run: echo "${{ env.password }}" | docker login ${{ env.registry }} -u ${{ env.username }} --password-stdin

      - name: Determine tags based on branch
        id: tags
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Production tags
            echo "TAGS=$IMAGE_NAME:latest,$IMAGE_NAME:prod-${{ github.sha }},$IMAGE_NAME:stable" >> $GITHUB_ENV
            echo "ENV_TAG=PROD" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            # Development tags
            echo "TAGS=$IMAGE_NAME:dev,$IMAGE_NAME:dev-${{ github.sha }},$IMAGE_NAME:dev-latest" >> $GITHUB_ENV
            echo "ENV_TAG=DEV" >> $GITHUB_ENV
          else
            # Pull request tags
            echo "TAGS=$IMAGE_NAME:pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
            echo "ENV_TAG=PR-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          fi

      - name: Build Docker image
        run: |
          cd services/counter-agent
          
          # Build with environment label
          docker build \
            --label "environment=${{ env.ENV_TAG }}" \
            --label "commit=${{ github.sha }}" \
            --label "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "version=${{ github.run_number }}" \
            -t $IMAGE_NAME:build .

      - name: Tag images
        run: |
          # Tag with all appropriate tags
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.TAGS }}"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "Tagging as $tag"
            docker tag $IMAGE_NAME:build $tag
          done

      - name: Push images
        run: |
          # Push all tags
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.TAGS }}"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "Pushing $tag"
            docker push $tag
          done

      - name: Output summary
        run: |
          echo "## ðŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENV_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.TAGS }}"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
          done